<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>


   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112020731-1"></script>
   <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-112020731-1');
   </script>

 

  <meta charset="utf-8">
  <title>Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</title>
  <meta name="author" content="Yumi">



  <!-- https://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://FairyOnIce.github.io/favicon.png" rel="icon">
  <link href="https://FairyOnIce.github.io/theme/css/main.css" media="screen, projection"
rel="stylesheet" type="text/css">
 <link rel="stylesheet" href="https://FairyOnIce.github.io/theme/tipuesearch.css">
  <script src="https://FairyOnIce.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/ender.js"></script>
  <script src="https://FairyOnIce.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://FairyOnIce.github.io/">Yumi's Blog</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:FairyOnIce.github.io" />
    <input class="search" type="text" name="q" results="0"
placeholder="Google Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/archives.html">Archives</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/deployment.html">Deployment</a></li>
      <li><a href="https://FairyOnIce.github.io/pages/quest.html">Quest</a></li>
    <li class="active">
    <a href="https://FairyOnIce.github.io/category/blog.html">Blog</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</h1>
      <p class="meta"><time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time></p>
</header>

  <div class="entry-content"><style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p><img alt="YOLO v2 loss funciton" height="570" src="https://farm8.staticflickr.com/7904/45592720625_821897e898_b.jpg" width="1024" /></a></p>
<p>This is the fourth blog post of <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. 
This blog discusses the YOLO's loss funciton. This will be the most intense blog post in <a href="https://fairyonice.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection with YOLO blog series</a>. as loss function of YOLO is quite complex. So please get excited! 
For demonstration of the code, I will agian use PASCAL VOC2012 data. 
This blog assumes that the readers have read the previous blog posts - <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1</a>, <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a> and <a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3</a>.</p>
<h2 id="Andrew-Ng's-YOLO-lecture">Andrew Ng's YOLO lecture<a class="anchor-link" href="#Andrew-Ng's-YOLO-lecture">¶</a></h2><ul>
<li><a href="https://www.youtube.com/watch?v=gKreZOUi-O0&amp;t=0s&amp;index=7&amp;list=PL_IHmaMAvkVxdDOBRg2CbcJBq9SY7ZUvs">Neural Networks - Bounding Box Predictions</a></li>
<li><a href="https://www.youtube.com/watch?v=ANIzQ5G-XPE&amp;t=7s">C4W3L06 Intersection Over Union</a></li>
<li><a href="https://www.youtube.com/watch?v=VAo84c1hQX8&amp;t=192s">C4W3L07 Nonmax Suppression</a></li>
<li><a href="https://www.youtube.com/watch?v=RTlwl2bv0Tg&amp;t=28s">C4W3L08 Anchor Boxes</a></li>
<li><a href="https://www.youtube.com/watch?v=9s_FpMpdYW8&amp;t=34s">C4W3L09 YOLO Algorithm</a></li>
</ul>
<h2 id="Reference">Reference<a class="anchor-link" href="#Reference">¶</a></h2><ul>
<li><p><a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a></p>
</li>
<li><p><a href="https://arxiv.org/pdf/1612.08242.pdf">YOLO9000:Better, Faster, Stronger</a></p>
</li>
<li><p><a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a></p>
</li>
</ul>
<h2 id="Reference-in-my-blog">Reference in my blog<a class="anchor-link" href="#Reference-in-my-blog">¶</a></h2><ul>
<li><a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a></li>
<li><a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></li>
<li><a href="https://fairyonice.github.io/Part_3_Object_Detection_with_Yolo_using_VOC_2012_data_model.html">Part 3 Object Detection using YOLOv2 on Pascal VOC2012 - model</a></li>
<li><a href="https://fairyonice.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html">Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss</a></li>
<li><a href="https://fairyonice.github.io/Part_5_Object_Detection_with_Yolo_using_VOC_2012_data_training.html">Part 5 Object Detection using YOLOv2 on Pascal VOC2012 - training</a></li>
<li><a href="https://fairyonice.github.io/Part_6_Object_Detection_with_Yolo_using_VOC_2012_data_inference_image.html">Part 6 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on image</a></li>
<li><a href="https://fairyonice.github.io/Part_7_Object_Detection_with_Yolo_using_VOC_2012_data_inference_video.html">Part 7 Object Detection using YOLOv2 on Pascal VOC 2012 data - inference on video</a></li>
</ul>
<h2 id="My-GitHub-repository">My GitHub repository<a class="anchor-link" href="#My-GitHub-repository">¶</a></h2><p>This repository contains all the ipython notebooks in this blog series and the funcitons (See backend.py).</p>
<ul>
<li><a href="https://github.com/FairyOnIce/ObjectDetectionYolo">FairyOnIce/ObjectDetectionYolo</a></li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/yumikondo/anaconda3/lib/python3.6/site-packages/h5py/__init__.py:34: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>3.6.3 |Anaconda, Inc.| (default, Oct  6 2017, 12:04:38) 
[GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-anchor-box">Define anchor box<a class="anchor-link" href="#Define-anchor-box">¶</a></h2><p><code>ANCHORS</code> defines the number of anchor boxes and the shape of each anchor box.
The choice of the anchor box specialization is already discussed in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a>.</p>
<p>Based on the K-means analysis in the previous blog post, I will select 4 anchor boxes of following width and height. The width and heights are rescaled in the grid cell scale (Assuming that the number of grid size is 13 by 13.) See <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a> to learn how I rescal the anchor box shapes into the grid cell scale.</p>
<p>Here I choose 4 anchor boxes. With 13 by 13 grids, every frame gets 4 x 13 x 13 = 676 bouding box predictions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ANCHORS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.07709888</span><span class="p">,</span>  <span class="mf">1.78171903</span><span class="p">,</span>  <span class="c1"># anchor box 1, width , height</span>
                    <span class="mf">2.71054693</span><span class="p">,</span>  <span class="mf">5.12469308</span><span class="p">,</span>  <span class="c1"># anchor box 2, width,  height</span>
                   <span class="mf">10.47181473</span><span class="p">,</span> <span class="mf">10.09646365</span><span class="p">,</span>  <span class="c1"># anchor box 3, width,  height</span>
                    <span class="mf">5.48531347</span><span class="p">,</span>  <span class="mf">8.11011331</span><span class="p">])</span> <span class="c1"># anchor box 4, width,  height</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-Label-vector-containing-20-object-classe-names.">Define Label vector containing 20 object classe names.<a class="anchor-link" href="#Define-Label-vector-containing-20-object-classe-names.">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LABELS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'aeroplane'</span><span class="p">,</span>  <span class="s1">'bicycle'</span><span class="p">,</span> <span class="s1">'bird'</span><span class="p">,</span>  <span class="s1">'boat'</span><span class="p">,</span>      <span class="s1">'bottle'</span><span class="p">,</span> 
          <span class="s1">'bus'</span><span class="p">,</span>        <span class="s1">'car'</span><span class="p">,</span>      <span class="s1">'cat'</span><span class="p">,</span>  <span class="s1">'chair'</span><span class="p">,</span>     <span class="s1">'cow'</span><span class="p">,</span>
          <span class="s1">'diningtable'</span><span class="p">,</span><span class="s1">'dog'</span><span class="p">,</span>    <span class="s1">'horse'</span><span class="p">,</span>  <span class="s1">'motorbike'</span><span class="p">,</span> <span class="s1">'person'</span><span class="p">,</span>
          <span class="s1">'pottedplant'</span><span class="p">,</span><span class="s1">'sheep'</span><span class="p">,</span>  <span class="s1">'sofa'</span><span class="p">,</span>   <span class="s1">'train'</span><span class="p">,</span>   <span class="s1">'tvmonitor'</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="YOLOv2's-loss-function">YOLOv2's loss function<a class="anchor-link" href="#YOLOv2's-loss-function">¶</a></h1><p>Before discussing the loss function, I will read in VOC2012 data, and call the batch generator in order to use the example batch <code> [x_batch,b_batch],y_batch</code> to demonstrate the usage of the loss funciton.</p>
<h3 id="Read-images-and-annotations-into-memory">Read images and annotations into memory<a class="anchor-link" href="#Read-images-and-annotations-into-memory">¶</a></h3><p>Use the pre-processing code for parsing annotation at <a href="https://github.com/experiencor/keras-yolo2">experiencor/keras-yolo2</a>.
This <code>parse_annoation</code> function is already used in <a href="https://fairyonice.github.io/Part_1_Object_Detection_with_Yolo_for_VOC_2014_data_anchor_box_clustering.html">Part 1 Object Detection using YOLOv2 on Pascal VOC2012 - anchor box clustering</a> and saved in my python script. 
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">### The location where the VOC2012 data is saved.</span>
<span class="n">train_image_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/JPEGImages/"</span>
<span class="n">train_annot_folder</span> <span class="o">=</span> <span class="s2">"../ObjectDetectionRCNN/VOCdevkit/VOC2012/Annotations/"</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">parse_annotation</span>
<span class="n">train_image</span><span class="p">,</span> <span class="n">seen_train_labels</span> <span class="o">=</span> <span class="n">parse_annotation</span><span class="p">(</span><span class="n">train_annot_folder</span><span class="p">,</span>
                                                  <span class="n">train_image_folder</span><span class="p">,</span> 
                                                  <span class="n">labels</span><span class="o">=</span><span class="n">LABELS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"N train = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_image</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stderr output_text">
<pre>Using TensorFlow backend.
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>N train = 17125
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Instantiate-batch-generator-object">Instantiate batch generator object<a class="anchor-link" href="#Instantiate-batch-generator-object">¶</a></h3><p><code>SimpleBatchGenerator</code> is discussed and used in 
<a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>.
This script can be downloaded at <a href="https://github.com/FairyOnIce/ObjectDetectionYolo/blob/master/backend.py">my Github repository, FairyOnIce/ObjectDetectionYolo/backend</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">backend</span> <span class="k">import</span> <span class="n">SimpleBatchGenerator</span>

<span class="n">BATCH_SIZE</span>        <span class="o">=</span> <span class="mi">500</span>
<span class="n">IMAGE_H</span><span class="p">,</span> <span class="n">IMAGE_W</span>  <span class="o">=</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">416</span>
<span class="n">GRID_H</span><span class="p">,</span>  <span class="n">GRID_W</span>   <span class="o">=</span> <span class="mi">13</span> <span class="p">,</span> <span class="mi">13</span>
<span class="n">TRUE_BOX_BUFFER</span>   <span class="o">=</span> <span class="mi">50</span>
<span class="n">BOX</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># CLASS             = len(LABELS)</span>

<span class="n">generator_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'IMAGE_H'</span>         <span class="p">:</span> <span class="n">IMAGE_H</span><span class="p">,</span> 
    <span class="s1">'IMAGE_W'</span>         <span class="p">:</span> <span class="n">IMAGE_W</span><span class="p">,</span>
    <span class="s1">'GRID_H'</span>          <span class="p">:</span> <span class="n">GRID_H</span><span class="p">,</span>  
    <span class="s1">'GRID_W'</span>          <span class="p">:</span> <span class="n">GRID_W</span><span class="p">,</span>
    <span class="s1">'LABELS'</span>          <span class="p">:</span> <span class="n">LABELS</span><span class="p">,</span>
    <span class="s1">'ANCHORS'</span>         <span class="p">:</span> <span class="n">ANCHORS</span><span class="p">,</span>
    <span class="s1">'BATCH_SIZE'</span>      <span class="p">:</span> <span class="n">BATCH_SIZE</span><span class="p">,</span>
    <span class="s1">'TRUE_BOX_BUFFER'</span> <span class="p">:</span> <span class="n">TRUE_BOX_BUFFER</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.</span>
<span class="n">train_batch_generator</span> <span class="o">=</span> <span class="n">SimpleBatchGenerator</span><span class="p">(</span><span class="n">train_image</span><span class="p">,</span> <span class="n">generator_config</span><span class="p">,</span>
                                             <span class="n">norm</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="p">[</span><span class="n">x_batch</span><span class="p">,</span><span class="n">b_batch</span><span class="p">],</span><span class="n">y_batch</span> <span class="o">=</span> <span class="n">train_batch_generator</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Calculating-YOLOv2's-loss-function">Calculating YOLOv2's loss function<a class="anchor-link" href="#Calculating-YOLOv2's-loss-function">¶</a></h1><p>I have seen a lot of online blog posts about YOLO v1 loss function.
For example, at <a href="https://hackernoon.com/understanding-yolo-f5a74bbc7967">Understanding YOLO</a>.
However, most of these posts discusses the loss function of Yolo v1 which must be different from Yolo v2.
The two losses are different and the lack of explicit formula in the Yolo v2 loss paper rises some confusion, for example at <a href="https://groups.google.com/forum/#!topic/darknet/TJ4dN9R4iJk">What is YOLOv2 Loss Function - Google Groups</a>.</p>
<p>The YOLO v1 is difined in 
<a href="https://arxiv.org/pdf/1506.02640.pdf">You Only Look Once:Unified, Real-Time Object Detection</a> as:</p>
<h3 id="YOLO-V1-loss">YOLO V1 loss<a class="anchor-link" href="#YOLO-V1-loss">¶</a></h3><p>$$\begin{array}{rl}
&\lambda_\textbf{coord}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
     L_{ij}^{\text{obj}}
            \left[
            \left(
                x_i - \hat{x}_i
            \right)^2 +
            \left(
                y_i - \hat{y}_i
            \right)^2
            \right]
\\
&+ \lambda_\textbf{coord} 
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
         L_{ij}^{\text{obj}}
         \left[
        \left(
            \sqrt{w_i} - \sqrt{\hat{w}_i}
        \right)^2 +
        \left(
            \sqrt{h_i} - \sqrt{\hat{h}_i}
        \right)^2
        \right]
\\
&+ \sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
        L_{ij}^{\text{obj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \lambda_\textrm{noobj}
\sum_{i = 0}^{S^2}
    \sum_{j = 0}^{B}
    L_{ij}^{\text{noobj}}
        \left(
            C_i - \hat{C}_i
        \right)^2
\\
&+ \sum_{i = 0}^{S^2}
L_i^{\text{obj}}
    \sum_{c \in \textrm{classes}}
        \left(
            p_i(c) - \hat{p}_i(c)
        \right)^2
\end{array}$$</p>
<p>YOLOv2 paper expalins the difference in architecture from YOLOv1 as follows:</p>
<blockquote>
We remove the fully connected layers from YOLO(v1) and use anchor boxes to predict bounding boxes...
When we move to anchor boxes we also decouple the class prediction mechanism from the spatial location and instead predict class and objectness for every anchorbox. 
</blockquote><p>This means that the confidence probability $p_i(c)$ above should depend not only on $i$ and $c$ but also an anchor box index, say $j$. Therefore, the loss needs to be different from above. Unfortunately, YOLOv2 paper does not explicitly state its loss function. So rather than making a guess based on the paper, I will try to understand the loss function that <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a> defines for his YOLOv2.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="experiencor/keras-yolo2's-YOLO-V2-loss"><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss<a class="anchor-link" href="#experiencor/keras-yolo2's-YOLO-V2-loss">¶</a></h3><p>In <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a>, I showed that YOLO's output is encoded into <code>y_batch</code>.</p>
<p>Here I revisit YOLO's ground truth output encoding with mathematical notations.</p>
<p><code>
y_batch
</code></p>
<p>The numpy array of shape  <code>(BATCH_SIZE, GRID_H, GRID_W, BOX, 4 + 1 + N classes) </code>.</p>
<p>BOX = The number of anchor boxes.</p>
<p>In the following notation, the grid cell index can be defined by two index (<code>igrid_h</code>,<code>igrid_w</code>) or by a single index $i$; (<code>igrid_h</code>,<code>igrid_w</code>) $\leftrightarrow i$</p>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code> contains <code>(center_x,center_y,center_w,center_h)</code> of <code>j</code>th anchor at <code>grid cell=(igrid_h,igrid_w)</code> = $i$, 
  if the object exists in this (grid cell, anchor) pair, else they simply contain 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,:4]</code>$= (x_{i,\texttt{j}},y_{i,\texttt{j}},w_{i,\texttt{j}},h_{i,\texttt{j}})$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> 
  contains 1 if the object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,4]</code> = $ C_{i,\texttt{j}}$</p>
</li>
</ul>
<ul>
<li><p><code>y_batch[iframe,igrid_h,igrid_w,j,5 + iclass]</code> contains 1 if the <code>iclass</code>th class object exists in this (grid cell, anchor) pair, else it contains 0.</p>
<p><code>y_batch[iframe,igrid_h,igrid_w,j,5:]</code> $ = (p^1_{i,\texttt{j}},p^2_{i,\texttt{j}},p^3_{i,\texttt{j}},\cdots,p^{\textrm{Nclass}}_{i,\texttt{j}})$</p>
</li>
</ul>
<p>The loss function of YOLO treats each set of elements 
<code>(center_x,center_y,center_w,center_h)</code>, 
<code>C</code>, and 
<code>(p_1,p_2,...p_Nclass)</code> in <code>y_batch[iframe,igrid_h,igrid_w,:]</code> differently. So let's understand each term of the loss one by one.</p>
<p>Then the loss corresponding to (grid cell, anchor box) pair = ($i,j$) is calculated as:</p>
<p>$$\small
%%%
\begin{array}{rl}\small
\textrm{loss}_{i,j} &= \textrm{loss}_{i,j}^{xywh} +  \textrm{loss}_{i,j}^p + \textrm{loss}_{i,j}^c \\
%%%
\textrm{loss}_{i,j}^{xywh}&=
\frac{\lambda_{\textrm{coord}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]\\
%%%
\textrm{loss}_{i,j}^p&=
-\frac{\lambda_{\text{class}}}{N_{L^{obj}}}
\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)\\
%%%
\textrm{loss}_{i,j}^c &=
\frac{\lambda_{\text{obj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;+
\frac{\lambda_{\textrm{noobj}}}{N^{conf}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)\\
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>where:</p>
<ul>
<li>$N_{L^{obj}} = \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}}$</li>
<li><p>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</p>
</li>
<li><p>$\text{preduiction}_{i,j}=(\hat{x}_{i,j},\hat{y}_{i,j},\hat{w}_{i,j},\hat{h}_{i,j})$</p>
</li>
<li>$\text{ground truth}_{i,j}=(x_{i,j},y_{i,j},w_{i,j},h_{i,j})$</li>
<li>$\lambda_{\text{coord}}$, $\lambda_{\text{class}}$ and $\lambda_{\text{noobj}}$ are scalars to weight each loss funciton </li>
</ul>
<p>Here, $L_{i,j}^{\text{noobj}}$ and $L_{i,j}^{\text{obj}}$ are 0/1 indicator function such that:
$$
\begin{array}{rl}
L_{i,j}^{\text{obj}}
 &= 
 \begin{cases}
 1 
\;\;\text{if} \;\;C_{i,j}=1\\
 0\;\;\text{else}\\
\end{cases}\\
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}\\
\end{array}
$$</p>
<p>As the loss function seems complex, let's go over the  <a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function line by line.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Global-hyperparameters-necessary-for-the-loss-function">Global hyperparameters necessary for the loss function<a class="anchor-link" href="#Global-hyperparameters-necessary-for-the-loss-function">¶</a></h3>
<pre><code>               -  true_boxes
               -  GRID_W
               -  GRID_H
               -  BATCH_SIZE
               -  ANCHORS
               -  LAMBDA_COORD
               -  LAMBDA_CLASS
               -  LAMBDA_NO_OBJECT 
               -  LAMBDA_OBJECT</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_NO_OBJECT</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_OBJECT</span>    <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">LAMBDA_COORD</span>     <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">LAMBDA_CLASS</span>     <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-1:-Adjust-prediction-output">Step 1: Adjust prediction output<a class="anchor-link" href="#Step-1:-Adjust-prediction-output">¶</a></h3><p><a href="https://github.com/experiencor/keras-yolo2/blob/master/Yolo%20Step-by-Step.ipynb">experiencor/keras-yolo2</a>'s YOLO V2 loss function starts off by rescaling the prediction output. 
Notice that the predicted y_batch output can take any real values as the conv_23 layer has a linear activation function. However, the prediction outputs should be rescaled in the following range:</p>
<ol>
<li>$\hat{x}_{i,j}$ ranges between [<code>igrid_w,igrid_w+1</code>).</li>
<li>$\hat{y}_{i,j}$ ranges between [<code>igrid_h,igrid_h+1</code>)</li>
<li>$\hat{w}_{i,j}$ ranges between 0, GRID_W</li>
<li>$\hat{h}_{i,j}$ ranges between 0, GRID_H</li>
<li>$\widehat{C}_{i,j}$ ranges between 0 and 1. </li>
<li>$\widehat{p^c}_{i,j}$ ranges between 0 and 1</li>
</ol>
<p>The 1, 2, 3 and 4 are because the bounding boxes are in grid cell scale. See Bounding box encoding Section in 
  <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2 Object Detection using YOLOv2 on Pascal VOC2012 - input and output encoding</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">):</span> 
    <span class="sd">'''</span>
<span class="sd">    Helper function to assure that the bounding box x and y are in the grid cell scale</span>
<span class="sd">    == output == </span>
<span class="sd">    for any i=0,1..,batch size - 1</span>
<span class="sd">    output[i,5,3,:,:] = array([[3., 5.],</span>
<span class="sd">                               [3., 5.],</span>
<span class="sd">                               [3., 5.]], dtype=float32)</span>
<span class="sd">    '''</span>
    <span class="c1">## cell_x.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_x[:,i,j,:] = [[[j]]]</span>
    <span class="n">cell_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">),</span> <span class="p">[</span><span class="n">GRID_H</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GRID_H</span><span class="p">,</span> <span class="n">GRID_W</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="c1">## cell_y.shape = (1, 13, 13, 1, 1)</span>
    <span class="c1">## cell_y[:,i,j,:] = [[[i]]]</span>
    <span class="n">cell_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cell_x</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="c1">## cell_gird.shape = (16, 13, 13, 5, 2)</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = j when k = 0</span>
    <span class="c1">## for any n, k, i, j</span>
    <span class="c1">##    cell_grid[n, i, j, anchor, k] = i when k = 1    </span>
    <span class="n">cell_grid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cell_x</span><span class="p">,</span><span class="n">cell_y</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BOX</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cell_grid</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">cell_grid</span><span class="p">,</span> <span class="n">ANCHORS</span><span class="p">):</span>    
    <span class="sd">"""</span>
<span class="sd">        Adjust prediction</span>
<span class="sd">        </span>
<span class="sd">        == input ==</span>
<span class="sd">        </span>
<span class="sd">        y_pred : takes any real values</span>
<span class="sd">                 tensor of shape = (N batch, NGrid h, NGrid w, NAnchor, 4 + 1 + N class)</span>
<span class="sd">        </span>
<span class="sd">        ANCHORS : list containing width and height specializaiton of anchor box</span>
<span class="sd">        == output ==</span>
<span class="sd">        </span>
<span class="sd">        pred_box_xy : shape = (N batch, N grid x, N grid y, N anchor, 2), contianing [center_y, center_x] rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,0] =  center_x</span>
<span class="sd">          pred_box_xy[irow,igrid_h,igrid_w,ianchor,1] =  center_1</span>
<span class="sd">          </span>
<span class="sd">          calculation process:</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) : takes values between 0 and 1</span>
<span class="sd">          tf.sigmoid(y_pred[...,:2]) + cell_grid : takes values between 0 and grid_W - 1 for x coordinate </span>
<span class="sd">                                                   takes values between 0 and grid_H - 1 for y coordinate </span>
<span class="sd">                                                   </span>
<span class="sd">        pred_Box_wh : shape = (N batch, N grid h, N grid w, N anchor, 2), containing width and height, rangining [0,0]x[grid_H-1,grid_W-1]</span>
<span class="sd">        </span>
<span class="sd">        pred_box_conf : shape = (N batch, N grid h, N grid w, N anchor, 1), containing confidence to range between 0 and 1</span>
<span class="sd">        </span>
<span class="sd">        pred_box_class : shape = (N batch, N grid h, N grid w, N anchor, N class), containing </span>
<span class="sd">    """</span>
    <span class="n">BOX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">## cell_grid is of the shape of </span>
    
    <span class="c1">### adjust x and y  </span>
    <span class="c1"># the bounding box bx and by are rescaled to range between 0 and 1 for given gird.</span>
    <span class="c1"># Since there are BOX x BOX grids, we rescale each bx and by to range between 0 to BOX + 1</span>
    <span class="n">pred_box_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">cell_grid</span> <span class="c1"># bx, by</span>
    
    <span class="c1">### adjust w and h</span>
    <span class="c1"># exp to make width and height positive</span>
    <span class="c1"># rescale each grid to make some anchor "good" at representing certain shape of bounding box </span>
    <span class="n">pred_box_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># bw, bh</span>

    <span class="c1">### adjust confidence </span>
    <span class="n">pred_box_conf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span><span class="c1"># prob bb</span>

    <span class="c1">### adjust class probabilities </span>
    <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:]</span> <span class="c1"># prC1, prC2, ..., prC20</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">pred_box_conf</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-adjust_scale_prediction">Experiment <code>adjust_scale_prediction</code><a class="anchor-link" href="#Experiment-adjust_scale_prediction">¶</a></h4><p>I generate the real valued y_pred before rescaling from Normal(mean=0,sd = const/(GRID_H*GRID_W)), as this will be my weight initializer for the layer 23 when const = 1. I will set const = 10 to make the distribution variance a bit larger.</p>
<p>The bounding box parameters x, y, w, h and confidence are in the expected range. 
However, the class probabilities can take negative values. This is ok because the loss function later applies  softmax to <code>y_pred[:,:,:,:,5:]</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2"> MIN=</span><span class="si">{:5.2f}</span><span class="s2">, MAX=</span><span class="si">{:5.2f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">title</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"prepare inputs"</span><span class="p">)</span>
<span class="n">GRID_W</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">GRID_H</span> <span class="o">=</span> <span class="mi">13</span> 
<span class="n">BOX</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ANCHORS</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">CLASS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LABELS</span><span class="p">)</span>
<span class="n">size</span>   <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="o">*</span><span class="n">GRID_W</span><span class="o">*</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">BOX</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">GRID_H</span><span class="o">*</span><span class="n">GRID_W</span><span class="p">))</span> 
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">BOX</span><span class="p">,</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">CLASS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"y_pred before scaling = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"define tensor graph"</span><span class="p">)</span>
<span class="n">y_pred_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">cell_grid</span> <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
<span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span> 
 <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred_tf</span><span class="p">,</span> 
                                                                <span class="n">cell_grid</span><span class="p">,</span> 
                                                                <span class="n">ANCHORS</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span>   <span class="n">pred_box_wh</span><span class="p">,</span> 
     <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>   <span class="n">pred_box_wh_tf</span><span class="p">,</span>
         <span class="n">pred_box_conf_tf</span><span class="p">,</span> <span class="n">pred_box_class_tf</span><span class="p">])</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>           
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                      <span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                  <span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  confidence "</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">pred_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">pred_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  class probability"</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
prepare inputs
y_pred before scaling = (500, 13, 13, 4, 25)
******************************
define tensor graph
******************************
ouput
******************************

pred_box_xy (500, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.44, MAX= 0.55
  bounding box x at iGRID_W=01 MIN= 1.44, MAX= 1.56
  bounding box x at iGRID_W=02 MIN= 2.44, MAX= 2.56
  bounding box x at iGRID_W=03 MIN= 3.43, MAX= 3.56
  bounding box x at iGRID_W=04 MIN= 4.44, MAX= 4.56
  bounding box x at iGRID_W=05 MIN= 5.44, MAX= 5.56
  bounding box x at iGRID_W=06 MIN= 6.44, MAX= 6.56
  bounding box x at iGRID_W=07 MIN= 7.44, MAX= 7.56
  bounding box x at iGRID_W=08 MIN= 8.44, MAX= 8.56
  bounding box x at iGRID_W=09 MIN= 9.44, MAX= 9.55
  bounding box x at iGRID_W=10 MIN=10.44, MAX=10.56
  bounding box x at iGRID_W=11 MIN=11.44, MAX=11.56
  bounding box x at iGRID_W=12 MIN=12.44, MAX=12.56
  bounding box y at iGRID_H=00 MIN= 0.44, MAX= 0.57
  bounding box y at iGRID_H=01 MIN= 1.45, MAX= 1.56
  bounding box y at iGRID_H=02 MIN= 2.44, MAX= 2.56
  bounding box y at iGRID_H=03 MIN= 3.44, MAX= 3.57
  bounding box y at iGRID_H=04 MIN= 4.44, MAX= 4.56
  bounding box y at iGRID_H=05 MIN= 5.44, MAX= 5.56
  bounding box y at iGRID_H=06 MIN= 6.44, MAX= 6.56
  bounding box y at iGRID_H=07 MIN= 7.45, MAX= 7.55
  bounding box y at iGRID_H=08 MIN= 8.44, MAX= 8.56
  bounding box y at iGRID_H=09 MIN= 9.44, MAX= 9.56
  bounding box y at iGRID_H=10 MIN=10.44, MAX=10.55
  bounding box y at iGRID_H=11 MIN=11.44, MAX=11.57
  bounding box y at iGRID_H=12 MIN=12.44, MAX=12.56

pred_box_wh (500, 13, 13, 4, 2)
  bounding box width  MIN= 0.81, MAX=13.47
  bounding box height MIN= 1.37, MAX=12.87

pred_box_conf (500, 13, 13, 4)
  confidence  MIN= 0.43, MAX= 0.57

pred_box_class (500, 13, 13, 4, 20)
  class probability MIN=-0.30, MAX= 0.29
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-2:-Extract-ground-truth-output">Step 2: Extract ground truth output<a class="anchor-link" href="#Step-2:-Extract-ground-truth-output">¶</a></h3><p>Extraction of the ground truth output is simpler than the extraction of the prediction output because the ground truth is already encoded in the correct scales.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">):</span>    
    <span class="n">true_box_xy</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># bounding box x, y coordinate in grid cell scale </span>
    <span class="n">true_box_wh</span>    <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># number of cells accross, horizontally and vertically</span>
    <span class="n">true_box_conf</span>  <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>    <span class="c1"># confidence </span>
    <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-extract_ground_truth">Experiment <code>extract_ground_truth</code><a class="anchor-link" href="#Experiment-extract_ground_truth">¶</a></h4><p>The scales of the $C_{i,j}$ and ${p^c}_{i,j}$ are different from $\widehat{C}_{i,j}$ and $\widehat{p^c}_{i,j}$, as the their ground truths take 0/1 values:</p>
<table>
<tr>
<th></th>
<th>Estimate</th>
<th>Ground truth</th>
</tr>
<tr>
<th>$C_{i,j}$</th>
<td>between 0 and 1 </td>
<td>1 (=an object exists) or 0</td>
</tr>
<tr>
<td>$p^c_{i,j}$</td>
<td>between 0 and 1</td>
<td>1 (=$c$th class object exists) or 0
    </td>
</tr>
<tr>
<td></td>
<td></td>
<td>later transfered to class index  $c$</td>
</tr>
</table><p>When $C_{i,j}=1$, the scales of $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ are the same as $\hat{x}_{i,j}$, $\hat{y}_{i,j}$, $\hat{w}_{i,j}$, $\hat{h}_{i,j}$.
When $C_{i,j}=0$, then all bounding box parameters $x_{i,j}$, $y_{i,j}$, $w_{i,j}$, $h_{i,j}$ takes zero values as no object exists for the (grid_cell, anchor) pair.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># y_batch is the output of the simpleBatchGenerator.fit()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Input y_batch = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

<span class="n">y_batch_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span> 
 <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> 
         <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">true_box_xy_tf</span><span class="p">,</span>   <span class="n">true_box_wh_tf</span><span class="p">,</span> 
                     <span class="n">true_box_conf_tf</span><span class="p">,</span> <span class="n">true_box_class_tf</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_xy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>        
<span class="k">for</span> <span class="n">igrid_w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,:,</span><span class="n">igrid_w</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box x at iGRID_W=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_w</span><span class="p">))</span>
    
<span class="k">for</span> <span class="n">igrid_h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_xy</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="n">true_box_conf</span><span class="p">[:,</span><span class="n">igrid_h</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">## only pick C_ij = 1</span>
    <span class="n">print_min_max</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">],</span><span class="s2">"  bounding box y at iGRID_H=</span><span class="si">{:02.0f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">igrid_h</span><span class="p">))</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_wh </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box width "</span><span class="p">)</span> 
<span class="n">print_min_max</span><span class="p">(</span><span class="n">true_box_wh</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="s2">"  bounding box height"</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_conf </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  confidence, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_conf</span><span class="o">.</span><span class="n">flatten</span><span class="p">())))</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">true_box_class </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"  class index, unique value = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_box_class</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Input y_batch = (500, 13, 13, 4, 25)
******************************
ouput
******************************

true_box_xy (500, 13, 13, 4, 2)
  bounding box x at iGRID_W=00 MIN= 0.17, MAX= 0.94
  bounding box x at iGRID_W=01 MIN= 1.00, MAX= 1.97
  bounding box x at iGRID_W=02 MIN= 2.02, MAX= 2.98
  bounding box x at iGRID_W=03 MIN= 3.03, MAX= 3.97
  bounding box x at iGRID_W=04 MIN= 4.02, MAX= 4.98
  bounding box x at iGRID_W=05 MIN= 5.00, MAX= 5.98
  bounding box x at iGRID_W=06 MIN= 6.00, MAX= 6.98
  bounding box x at iGRID_W=07 MIN= 7.00, MAX= 7.98
  bounding box x at iGRID_W=08 MIN= 8.02, MAX= 8.98
  bounding box x at iGRID_W=09 MIN= 9.02, MAX= 9.98
  bounding box x at iGRID_W=10 MIN=10.00, MAX=10.97
  bounding box x at iGRID_W=11 MIN=11.00, MAX=11.98
  bounding box x at iGRID_W=12 MIN=12.00, MAX=12.84
  bounding box y at iGRID_H=00 MIN= 0.41, MAX= 0.92
  bounding box y at iGRID_H=01 MIN= 1.02, MAX= 1.80
  bounding box y at iGRID_H=02 MIN= 2.00, MAX= 2.97
  bounding box y at iGRID_H=03 MIN= 3.03, MAX= 3.98
  bounding box y at iGRID_H=04 MIN= 4.00, MAX= 4.98
  bounding box y at iGRID_H=05 MIN= 5.00, MAX= 5.98
  bounding box y at iGRID_H=06 MIN= 6.00, MAX= 6.98
  bounding box y at iGRID_H=07 MIN= 7.00, MAX= 7.98
  bounding box y at iGRID_H=08 MIN= 8.00, MAX= 8.98
  bounding box y at iGRID_H=09 MIN= 9.00, MAX= 9.97
  bounding box y at iGRID_H=10 MIN=10.00, MAX=10.97
  bounding box y at iGRID_H=11 MIN=11.00, MAX=11.98
  bounding box y at iGRID_H=12 MIN=12.02, MAX=12.41

true_box_wh (500, 13, 13, 4, 2)
  bounding box width  MIN= 0.00, MAX=13.00
  bounding box height MIN= 0.00, MAX=13.00

true_box_conf (500, 13, 13, 4)
  confidence, unique value = [0. 1.]

true_box_class (500, 13, 13, 4)
  class index, unique value = [ 0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19]
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">Step 3: calculate $\text{loss}_{i,j}^{xywh}$<a class="anchor-link" href="#Step-3:-calculate-$\text{loss}_{i,j}^{xywh}$">¶</a></h3><p>Now we are ready to calculate the loss specific to the bounding box parameters.</p>
<p>\begin{array}{rl}
\textrm{loss}_{i,j}^{xywh}&=
\frac{1}{N_{L^{obj}}}
\lambda_{\textrm{coord}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\big[
\left(x_{i,j}-\hat{x}_{i,j}\right)^2 + 
\left(y_{i,j}-\hat{y}_{i,j}\right)^2 +\\
&\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\left(\sqrt{w}_{i,j}-\sqrt{\hat{w}}_{i,j}\right)^2 +
\left(\sqrt{h}_{i,j}-\sqrt{\hat{h}}_{i,j}\right)^2 
\big]
\end{array}</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                   <span class="n">COORD_SCALE</span><span class="p">,</span>
                   <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    coord_mask:      np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
<span class="sd">                     lambda_{coord} L_{i,j}^{obj}     </span>
<span class="sd">                         </span>
<span class="sd">    '''</span>
    
    <span class="c1"># lambda_{coord} L_{i,j}^{obj} </span>
    <span class="c1"># np.array of shape (Nbatch, Ngrid h, N grid w, N anchor, 1)</span>
    <span class="n">coord_mask</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">COORD_SCALE</span> 
    <span class="n">nb_coord_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">coord_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_xy</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_xy</span><span class="o">-</span><span class="n">pred_box_xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">loss_wh</span>      <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_wh</span><span class="o">-</span><span class="n">pred_box_wh</span><span class="p">)</span> <span class="o">*</span> <span class="n">coord_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_coord_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_xy</span> <span class="o">+</span> <span class="n">loss_wh</span><span class="p">,</span> <span class="n">coord_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_xywh">Experiment <code>calc_loss_xywh</code><a class="anchor-link" href="#Experiment-calc_loss_xywh">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_COORD</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_xywh_tf</span><span class="p">,</span> <span class="n">coord_mask_tf</span>  <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                               <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">pred_box_xy_tf</span><span class="p">,</span><span class="n">true_box_wh_tf</span><span class="p">,</span><span class="n">pred_box_wh_tf</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_xywh</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">loss_xywh_tf</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_xywh = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_xywh</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_xywh = 3.281
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-4:-calculate-$\text{loss}_{i,j}^{p}$">Step 4: calculate $\text{loss}_{i,j}^{p}$<a class="anchor-link" href="#Step-4:-calculate-$\text{loss}_{i,j}^{p}$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^p=-\frac{1}{N_{L^{obj}}}
\lambda_{\text{class}}\sum_{i=0}^{S^2} \sum_{j=0}^B L_{i,j}^{\text{obj}}
\sum_{c \in \text{class}}  p_{i,j}^c \text{log}(\hat{p}_{i,j}^c)
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">CLASS_SCALE</span><span class="p">,</span> <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == input ==    </span>
<span class="sd">    true_box_conf  : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor), containing class index</span>
<span class="sd">    pred_box_class : tensor of shape (N batch, N grid h, N grid w, N anchor, N class)</span>
<span class="sd">    CLASS_SCALE    : 1.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==  </span>
<span class="sd">    class_mask</span>
<span class="sd">    if object exists in this (grid_cell, anchor) pair and the class object receive nonzero weight</span>
<span class="sd">        class_mask[iframe,igridy,igridx,ianchor] = 1 </span>
<span class="sd">    else: </span>
<span class="sd">        0 </span>
<span class="sd">    '''</span>   
    <span class="n">class_mask</span>   <span class="o">=</span> <span class="n">true_box_conf</span>  <span class="o">*</span> <span class="n">CLASS_SCALE</span> <span class="c1">## L_{i,j}^obj * lambda_class</span>
    
    <span class="n">nb_class_box</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">class_mask</span> <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sparse_softmax_cross_entropy_with_logits</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="n">true_box_class</span><span class="p">,</span> 
                                                                  <span class="n">logits</span> <span class="o">=</span> <span class="n">pred_box_class</span><span class="p">)</span>
    <span class="n">loss_class</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">loss_class</span> <span class="o">*</span> <span class="n">class_mask</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_class_box</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>   
    <span class="k">return</span><span class="p">(</span><span class="n">loss_class</span><span class="p">)</span>


<span class="c1">#Example useage of tf.gather</span>
<span class="c1">#indices = np.array([[0,0],</span>
<span class="c1">#                    [1,0],</span>
<span class="c1">#                    [0,1]])</span>

<span class="c1">#arr  = tf.constant(indices)</span>
<span class="c1">#temp = tf.gather(np.array([100,-20]), arr)</span>
<span class="c1">#with tf.Session() as sess:</span>
<span class="c1">#    t = sess.run(temp)</span>
<span class="c1">#print(t)</span>

<span class="c1">#[[100 100]</span>
<span class="c1"># [-20 100]</span>
<span class="c1"># [100 -20]]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_loss_class">Experiment <code>calc_loss_class</code><a class="anchor-link" href="#Experiment-calc_loss_class">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">LAMBDA_CLASS</span>   <span class="o">=</span> <span class="mi">1</span>
<span class="n">loss_class_tf</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                 <span class="n">true_box_class_tf</span><span class="p">,</span><span class="n">pred_box_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
        <span class="n">loss_class</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_class_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_class = </span><span class="si">{:4.3f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_class</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
ouput
******************************
loss_class = 3.000
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="$\textrm{loss}_{i,j}^c$">$\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#$\textrm{loss}_{i,j}^c$">¶</a></h2><p>The rest of calculation is dedicated to evaluate confidence loss $\textrm{loss}_{i,j}^c$</p>
<p>$$
\textrm{loss}_{i,j}^c =\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
$$</p>
<h3 id="Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">Step 5, calculate $IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $<a class="anchor-link" href="#Step-5,-calculate-$IOU_{\text{preduiction}_{i,j}}^{\text{ground-truth}_{i,j}}-$">¶</a></h3><p>For each (grid cell, anchor) pair, compute IOU between ground truth bounding box and predicted bounding box.
$IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} $ is 0 if $C_{i,j}=0$.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span><span class="n">true_wh</span><span class="p">,</span>
                       <span class="n">pred_xy</span><span class="p">,</span><span class="n">pred_wh</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    == INPUT ==</span>
<span class="sd">    true_xy,pred_xy, true_wh and pred_wh must have the same shape length</span>

<span class="sd">    p1 : pred_mins = (px1,py1)</span>
<span class="sd">    p2 : pred_maxs = (px2,py2)</span>
<span class="sd">    t1 : true_mins = (tx1,ty1) </span>
<span class="sd">    t2 : true_maxs = (tx2,ty2) </span>
<span class="sd">                 p1______________________ </span>
<span class="sd">                 |      t1___________   |</span>
<span class="sd">                 |       |           |  |</span>
<span class="sd">                 |_______|___________|__|p2 </span>
<span class="sd">                         |           |rmax</span>
<span class="sd">                         |___________|</span>
<span class="sd">                                      t2</span>
<span class="sd">    intersect_mins : rmin = t1  = (tx1,ty1)</span>
<span class="sd">    intersect_maxs : rmax = (rmaxx,rmaxy)</span>
<span class="sd">    intersect_wh   : (rmaxx - tx1, rmaxy - ty1)</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">true_wh_half</span> <span class="o">=</span> <span class="n">true_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">true_mins</span>    <span class="o">=</span> <span class="n">true_xy</span> <span class="o">-</span> <span class="n">true_wh_half</span>
    <span class="n">true_maxes</span>   <span class="o">=</span> <span class="n">true_xy</span> <span class="o">+</span> <span class="n">true_wh_half</span>
    
    <span class="n">pred_wh_half</span> <span class="o">=</span> <span class="n">pred_wh</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">pred_mins</span>    <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">-</span> <span class="n">pred_wh_half</span>
    <span class="n">pred_maxes</span>   <span class="o">=</span> <span class="n">pred_xy</span> <span class="o">+</span> <span class="n">pred_wh_half</span>    
    
    <span class="n">intersect_mins</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pred_mins</span><span class="p">,</span>  <span class="n">true_mins</span><span class="p">)</span>
    <span class="n">intersect_maxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pred_maxes</span><span class="p">,</span> <span class="n">true_maxes</span><span class="p">)</span>
    <span class="n">intersect_wh</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">intersect_maxes</span> <span class="o">-</span> <span class="n">intersect_mins</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">intersect_areas</span> <span class="o">=</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">intersect_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="n">true_areas</span> <span class="o">=</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">true_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pred_areas</span> <span class="o">=</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pred_wh</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">union_areas</span> <span class="o">=</span> <span class="n">pred_areas</span> <span class="o">+</span> <span class="n">true_areas</span> <span class="o">-</span> <span class="n">intersect_areas</span>
    <span class="n">iou_scores</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">truediv</span><span class="p">(</span><span class="n">intersect_areas</span><span class="p">,</span> <span class="n">union_areas</span><span class="p">)</span>    
    <span class="k">return</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                <span class="n">pred_box_xy</span><span class="p">,</span>  <span class="n">pred_box_wh</span><span class="p">):</span>
    <span class="sd">''' </span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor )</span>
<span class="sd">    true_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    true_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_xy   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">    pred_box_wh   : tensor of shape (N batch, N grid h, N grid w, N anchor , 2)</span>
<span class="sd">        </span>
<span class="sd">    == output ==</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf : tensor of shape (N batch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    true_box_conf value depends on the predicted values </span>
<span class="sd">    true_box_conf = IOU_{true,pred} if objecte exist in this anchor else 0</span>
<span class="sd">    '''</span>
    <span class="n">iou_scores</span>        <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span>
                                            <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">iou_scores</span> <span class="o">*</span> <span class="n">true_box_conf</span>
    <span class="k">return</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_assigned">Experiment <code>calc_IOU_pred_true_assigned</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_assigned">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_box_conf_IOU_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span>
                            <span class="n">true_box_conf_tf</span><span class="p">,</span>
                            <span class="n">true_box_xy_tf</span><span class="p">,</span> <span class="n">true_box_wh_tf</span><span class="p">,</span>
                            <span class="n">pred_box_xy_tf</span><span class="p">,</span>  <span class="n">pred_box_wh_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">true_box_conf_IOU</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero true_box_conf_IOU = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero true_box_conf_IOU"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_conf_tf = Tensor("strided_slice_6:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_xy_tf   = Tensor("strided_slice_4:0", shape=(500, 13, 13, 4, 2), dtype=float32)
true_box_wh_tf   = Tensor("strided_slice_5:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul:0", shape=(500, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
true_box_conf_IOU.shape = (500, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXoAAAEmCAYAAABs7FscAAAABHNCSVQICAgIfAhkiAAAAAlwSFlz
AAALEgAACxIB0t1+/AAAADl0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uIDIuMS4wLCBo
dHRwOi8vbWF0cGxvdGxpYi5vcmcvpW3flQAAIABJREFUeJzt3Xm4XEWd//H3B8IeNIm5MCyBAIZB
YDToFVlcUFwQlcVRJCoQRQOO4OAyGsEZFsUBFVB/IBgHDChEUEAQUEEgIEjQBEJIZAsQJBKTCAKJ
IJrk+/ujqs1Jp29339vdt5PD5/U8/dxz6mx16nZ/u7pOnTqKCMzMrLzW6XYGzMyssxzozcxKzoHe
zKzkHOjNzErOgd7MrOQc6M3MSs6B3kpD0hxJ+3Q7H2ZrGgd6W2tImifprVVp4yXdBhARu0TE1Ab7
GC0pJA3pYFbN1igO9GZt5C8QWxM50FtpFGv8knaXNF3Ss5IWSjozr3Zr/vu0pKWS9pS0jqQvSXpM
0iJJF0l6aWG/h+dlT0r676rjnCTpJ5J+KOlZYHw+9h2Snpa0QNLZktYv7C8k/YekhyQtkfRlSTvk
bZ6VdFlxfbNWOdBbWX0L+FZEvATYAbgsp78x/x0WEUMj4g5gfH69GdgeGAqcDSBpZ+A7wIeALYCX
AltVHetA4CfAMOBiYDnwaWAksCewL/AfVdvsB7wG2AP4PDApH2MUsCswroVzN1uFA72tbX6aa8pP
S3qaFIRr+QfwckkjI2JpREyrs88PAWdGxCMRsRT4InBoboZ5H/CziLgtIv4O/A9QPUDUHRHx04hY
ERHPR8SMiJgWEcsiYh7wXeBNVducHhHPRsQcYDZwfT7+M8DPgd2aLxKz+hzobW1zUEQMq7xYvaZc
cSSwI3C/pN9JenedfW4JPFaYfwwYAmyelz1eWRARzwFPVm3/eHFG0o6SrpH0p9yc81VS7b5oYWH6
+RrzQ+vk16xfHOitlCLioYgYB2wGnA78RNImrF4bB3gC2LYwvw2wjBR8FwBbVxZI2gh4WfXhqubP
Be4HxuSmo+MBDfxszFrjQG+lJOnDknoiYgXwdE5eDiwGVpDa4iumAJ+WtJ2koaQa+KURsYzU9v4e
SXvlC6Qn0zhobwo8CyyVtBPwibadmNkAONBbWe0HzJG0lHRh9tCI+FtuejkVuD238+8BXAD8gNQj
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
NzMrOQd6M7OSc6A3Mys5B3ozs5Jr5glTF0haJGl2Ie1SSTPza17lgSSSRkt6vrDsvE5m3szMGmvm
CVOTgbOBiyoJEfGByrSkM4BnCus/HBFj25VBMzNrTTNPmLpV0uhay/LzZA8B3tLebJmZWbu02kb/
BmBhRDxUSNtO0t2SbpH0hhb3b2ZmLWqm6aaeccCUwvwCYJuIeFLSa4CfStolIp6t3lDSBGACwDbb
bNNiNszMrC8DrtFLGgK8F7i0khYRL0TEk3l6BvAwsGOt7SNiUkT0RkRvT0/PQLNhZmYNtNJ081bg
/oiYX0mQ1CNp3Ty9PTAGeKS1LJqZWSua6V45BbgD+FdJ8yUdmRcdyqrNNgBvBGZJugf4CXB0RDzV
zgybmVn/NNPrZlwf6eNrpF0OXN56tszWHKMnXtvtLJi1xHfGmpmVnAO9mVnJOdCbmZWcA72ZWck5
0JuZlZwDvZlZyTnQm5mVnAO9mVnJOdCbmZWcA72ZWck50JuZlZwDvZlZyTnQm5mVnAO9mVnJOdCb
mZVcMw8euUDSIkmzC2knSfqjpJn5tX9h2RclzZX0gKR3dCrjZmbWnGYeDj4ZOBu4qCr9rIj4RjFB
0s6kJ0/tAmwJ/ErSjhGxvA15tRcxP/zDbOAa1ugj4lag2ccBHgj8KD8k/FFgLrB7C/kzM7MWtdJG
f4ykWblpZ3hO2wp4vLDO/JxmZmZdMtBAfy6wAzAWWACckdNVY92otQNJEyRNlzR98eLFA8yGmZk1
MqBAHxELI2J5RKwAvsfK5pn5wKjCqlsDT/Sxj0kR0RsRvT09PQPJhpmZNWFAgV7SFoXZg4FKj5yr
gUMlbSBpO2AM8NvWsmhmZq1o2OtG0hRgH2CkpPnAicA+ksaSmmXmAUcBRMQcSZcBvweWAZ90jxsz
s+5qGOgjYlyN5PPrrH8qcGormTIzs/bxnbFmZiXnQG9mVnIO9GZmJedAb2ZWcg70ZmYl50BvZlZy
DvRmZiXnQG9mVnIO9GZmJedAb2ZWcg70ZmYl50BvZlZyDvRmZiXnQG9mVnIO9GZmJedAb2ZWcg0D
vaQLJC2SNLuQ9nVJ90uaJelKScNy+mhJz0uamV/ndTLzZmbWWDM1+snAflVpNwC7RsQrgQeBLxaW
PRwRY/Pr6PZk08zMBqphoI+IW4GnqtKuj4hleXYasHUH8mZmZm3Qjjb6jwI/L8xvJ+luSbdIekNf
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
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-6:-Calculate-$\text{max}_{i',j'}">Step 6: Calculate $\text{max}_{i',j'}<a class="anchor-link" href="#Step-6:-Calculate-$\text{max}_{i',j'}">¶</a></h3><p>\;\;IOU<em>{\text{preduiction}</em>{i,j}}^{\text{ground truth}_{i',j'}}$</p>
<p>For each predicted bounded box from (grid cell, anchor box), 
calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</p>
<p>This calculation uses true_boxes tensor. 
This tensor corresponds to the input <code>b_batch</code> from SimpleBatchGenerator, which is already introduced in <a href="https://fairyonice.github.io/Part%202_Object_Detection_with_Yolo_using_VOC_2014_data_input_and_output_encoding.html">Part 2</a>.</p>
<p>From the previous blog, I cite the <code>b_batch</code> description.</p>
<p><code>
b_batch
</code></p>
<p>The numpy array of shape <code>(BATCH_SIZE, 1, 1, 1, TRUE_BOX_BUFFER, 4)</code>.</p>
<ul>
<li><p><code>b_batch[iframe,1,1,1,ibuffer,:]</code> 
  contains <code>ibuffer</code>th object's <code>(center_x,center_y,center_w,center_h)</code> in <code>iframe</code>th frame.</p>
</li>
<li><p>If <code>ibuffer</code> > N objects in <code>iframe</code>th frame, then the values are simply 0.</p>
</li>
<li><p><code>TRUE_BOX_BUFFER</code> has to be some large number, so that the frame with the biggest number of objects can also record all objects.</p>
</li>
<li><p>The order of the objects do not matter.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">):</span>   
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    pred_box_xy : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    pred_box_wh : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    true_boxes  : tensor of shape (N batch, N grid h, N grid w, N anchor, 2)</span>
<span class="sd">    </span>
<span class="sd">    == output == </span>
<span class="sd">    </span>
<span class="sd">    best_ious</span>
<span class="sd">    </span>
<span class="sd">    for each iframe,</span>
<span class="sd">        best_ious[iframe,igridy,igridx,ianchor] contains</span>
<span class="sd">        </span>
<span class="sd">        the IOU of the object that is most likely included (or best fitted) </span>
<span class="sd">        within the bounded box recorded in (grid_cell, anchor) pair</span>
<span class="sd">        </span>
<span class="sd">        NOTE: a same object may be contained in multiple (grid_cell, anchor) pair</span>
<span class="sd">              from best_ious, you cannot tell how may actual objects are captured as the "best" object</span>
<span class="sd">    '''</span>
    <span class="n">true_xy</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    <span class="n">true_wh</span> <span class="o">=</span> <span class="n">true_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>           <span class="c1"># (N batch, 1, 1, 1, TRUE_BOX_BUFFER, 2)</span>
    
    <span class="n">pred_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    <span class="n">pred_wh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">pred_box_wh</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 1, 2)</span>
    
    <span class="n">iou_scores</span>  <span class="o">=</span>  <span class="n">get_intersect_area</span><span class="p">(</span><span class="n">true_xy</span><span class="p">,</span>
                                      <span class="n">true_wh</span><span class="p">,</span>
                                      <span class="n">pred_xy</span><span class="p">,</span>
                                      <span class="n">pred_wh</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor, 50)   </span>

    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">iou_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># (N batch, N grid_h, N grid_w, N anchor)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">best_ious</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-calc_IOU_pred_true_best">Experiment <code>calc_IOU_pred_true_best</code><a class="anchor-link" href="#Experiment-calc_IOU_pred_true_best">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">b_batch</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">best_ious_tf</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">,</span>
                                       <span class="n">pred_box_wh_tf</span><span class="p">,</span>
                                       <span class="n">true_boxes_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>    
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_xy_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_xy_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_wh_tf   = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_wh_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">ouput</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious.shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">best_ious</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">pick</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!=</span><span class="mi">0</span>
<span class="n">vec</span>  <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="n">pick</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Histogram</span><span class="se">\n</span><span class="s2">N (%) nonzero best_ious = </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:5.2f}</span><span class="s2">%)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pick</span><span class="p">),</span>
                                                             <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pick</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"nonzero best_ious"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
true_box_wh_tf   = Tensor("strided_slice_5:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_xy_tf   = Tensor("add:0", shape=(500, 13, 13, 4, 2), dtype=float32)
pred_box_wh_tf   = Tensor("mul:0", shape=(500, 13, 13, 4, 2), dtype=float32)
******************************
ouput
******************************
best_ious.shape = (500, 13, 13, 4)
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt"></div>
<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">Step 7: Calculate $\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$ and $\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$<a class="anchor-link" href="#Step-7:-Calculate-$\lambda_{\text{noobj}}L_{i,j}^{\text{noobj}}$-and-$\lambda_{\text{obj}}L_{i,j}^{\text{obj}}$">¶</a></h3><p>For each grid cell, calculate no object mask. 
$$
\begin{array}{rl}
L_{i,j}^{\text{noobj}}
& = 
\begin{cases}
 1 \;\;\text{if}\;\;\text{max}_{i',j'}
 \;\;IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i',j'}} < 0.6 \;\text{and}\; C_{i,j} = 0\\
 0\;\;\text{else}\\
\end{cases}
\end{array}
$$</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">):</span>    
    <span class="sd">'''</span>
<span class="sd">    == input == </span>
<span class="sd">    </span>
<span class="sd">    best_ious           : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf       : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU   : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    LAMBDA_NO_OBJECT    : 1.0</span>
<span class="sd">    LAMBDA_OBJECT       : 5.0</span>
<span class="sd">    </span>
<span class="sd">    == output ==</span>
<span class="sd">    conf_mask : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] = 0</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair and the region seems useless i.e. </span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has no object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  NO_OBJECT_SCALE</span>
<span class="sd">               when there is no object assigned in (grid cell, anchor) pair but region seems to include some object</span>
<span class="sd">               y_true[iframe,igridx,igridy,4] = 0 "and" the predicted region has some object that has IoU > 0.6</span>
<span class="sd">               </span>
<span class="sd">    conf_mask[iframe, igridy, igridx, ianchor] =  OBJECT_SCALE</span>
<span class="sd">              when there is an object in (grid cell, anchor) pair        </span>
<span class="sd">    '''</span>

    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">best_ious</span> <span class="o"><</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">true_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">LAMBDA_NO_OBJECT</span>
    <span class="c1"># penalize the confidence of the boxes, which are reponsible for corresponding ground truth box</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">conf_mask</span> <span class="o">+</span> <span class="n">true_box_conf_IOU</span> <span class="o">*</span> <span class="n">LAMBDA_OBJECT</span>
    <span class="k">return</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Experiment-get_conf_mask">Experiment <code>get_conf_mask</code><a class="anchor-link" href="#Experiment-get_conf_mask">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">conf_mask_tf</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_tf</span><span class="p">,</span> 
                             <span class="n">true_box_conf_IOU_tf</span><span class="p">,</span>
                             <span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> 
                             <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"best_ious         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_ious_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_NO_OBJECT  = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"LAMBDA_OBJECT     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">LAMBDA_OBJECT</span><span class="p">))</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask shape = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
best_ious         = Tensor("Max:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf     = Tensor("strided_slice_6:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf_IOU = Tensor("mul_9:0", shape=(500, 13, 13, 4), dtype=float32)
LAMBDA_NO_OBJECT  = 1.0
LAMBDA_OBJECT     = 5.0
******************************
output
******************************
conf_mask shape = (500, 13, 13, 4)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">Step 8: Calculate loss for the confidence $\textrm{loss}_{i,j}^c$<a class="anchor-link" href="#Step-8:-Calculate-loss-for-the-confidence-$\textrm{loss}_{i,j}^c$">¶</a></h3><p>$$
\textrm{loss}_{i,j}^c =
\frac{1}{N^{conf}}\left[
\lambda_{\text{obj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{obj}}
\left(
IOU_{\text{preduiction}_{i,j}}^{\text{ground truth}_{i,j}} - \widehat{C}_{i,j}
\right)^2+
\lambda_{\textrm{noobj}}
\sum_{i=0}^{S^2}
\sum_{j=0}^B
L_{i,j}^{\text{noobj}}
\left(0 - \widehat{C}_{i,j}\right)
\right]
$$</p>
<ul>
<li>$N^{conf} =  \sum_{i=0}^{S^2}
\sum_{j=0}^B L_{i,j}^{\text{obj}} + L_{i,j}^{\text{noobj}}(1-L_{i,j}^{\text{obj}})$</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">):</span>  
    <span class="sd">'''</span>
<span class="sd">    == input ==</span>
<span class="sd">    </span>
<span class="sd">    conf_mask         : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    true_box_conf_IOU : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    pred_box_conf     : tensor of shape (Nbatch, N grid h, N grid w, N anchor)</span>
<span class="sd">    '''</span>
    <span class="c1"># the number of (grid cell, anchor) pair that has an assigned object or</span>
    <span class="c1"># that has no assigned object but some objects may be in bounding box.</span>
    <span class="c1"># N conf</span>
    <span class="n">nb_conf_box</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">conf_mask</span>  <span class="o">></span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">loss_conf</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">true_box_conf_IOU</span><span class="o">-</span><span class="n">pred_box_conf</span><span class="p">)</span> <span class="o">*</span> <span class="n">conf_mask</span><span class="p">)</span>  <span class="o">/</span> <span class="p">(</span><span class="n">nb_conf_box</span>  <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-calc_loss_conf">Experiment <code>calc_loss_conf</code><a class="anchor-link" href="#Experiment-calc_loss_conf">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [22]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">input</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="s2">"conf_mask_tf         = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">))</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">"true_box_conf_IOU_tf = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">true_box_conf_IOU_tf</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pred_box_conf_tf     = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pred_box_conf_tf</span><span class="p">))</span>

<span class="n">loss_conf_tf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask_tf</span><span class="p">,</span><span class="n">true_box_conf_IOU_tf</span><span class="p">,</span> <span class="n">pred_box_conf_tf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_conf_tf</span><span class="p">)</span> 
    
<span class="nb">print</span><span class="p">(</span><span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">output</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"*"</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>      
<span class="nb">print</span><span class="p">(</span><span class="s2">"loss_conf = </span><span class="si">{:5.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loss_conf</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>******************************
input
******************************
conf_mask_tf         = Tensor("add_11:0", shape=(500, 13, 13, 4), dtype=float32)
true_box_conf_IOU_tf = Tensor("mul_9:0", shape=(500, 13, 13, 4), dtype=float32)
pred_box_conf_tf     = Tensor("Sigmoid_1:0", shape=(500, 13, 13, 4), dtype=float32)
******************************
output
******************************
loss_conf = 0.1249
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="custom_loss(y_true,y_pred)"><code>custom_loss(y_true,y_pred)</code><a class="anchor-link" href="#custom_loss(y_true,y_pred)">¶</a></h1><p>Finally combine all the calculation above into <code>custom_loss(y_true,y_pred)</code>
Notice that true_boxes are tensor defined when the Keras model is declared. 
However, this tensor will not be passed as explicit arguments of the loss function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [23]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">custom_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    y_true : (N batch, N grid h, N grid w, N anchor, 4 + 1 + N classes)</span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, :4] = center_x, center_y, w, h</span>
<span class="sd">    </span>
<span class="sd">        center_x : The x coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        center_y : The y coordinate center of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">        w        : The width of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  w (e.g., ranging between [0,13)</span>
<span class="sd">        h        : The height of the bounding box.</span>
<span class="sd">                   Rescaled to range between 0 and N gird  h (e.g., ranging between [0,13)</span>
<span class="sd">                   </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 4] = ground truth confidence</span>
<span class="sd">        </span>
<span class="sd">        ground truth confidence is 1 if object exists in this (anchor box, gird cell) pair</span>
<span class="sd">    </span>
<span class="sd">    y_true[irow, i_gridh, i_gridw, i_anchor, 5 + iclass] = 1 if the object is in category <iclass> else 0</span>
<span class="sd">        </span>
<span class="sd">    '''</span>
    <span class="n">total_recall</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    
    <span class="c1"># Step 1: Adjust prediction output</span>
    <span class="n">cell_grid</span>   <span class="o">=</span> <span class="n">get_cell_grid</span><span class="p">(</span><span class="n">GRID_W</span><span class="p">,</span><span class="n">GRID_H</span><span class="p">,</span><span class="n">BATCH_SIZE</span><span class="p">,</span><span class="n">BOX</span><span class="p">)</span>
    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">,</span> <span class="n">pred_box_class</span> <span class="o">=</span> <span class="n">adjust_scale_prediction</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">cell_grid</span><span class="p">,</span><span class="n">ANCHORS</span><span class="p">)</span>
    <span class="c1"># Step 2: Extract ground truth output</span>
    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_class</span> <span class="o">=</span> <span class="n">extract_ground_truth</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="c1"># Step 3: Calculate loss for the bounding box parameters</span>
    <span class="n">loss_xywh</span><span class="p">,</span> <span class="n">coord_mask</span> <span class="o">=</span> <span class="n">calc_loss_xywh</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_COORD</span><span class="p">,</span>
                                           <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">pred_box_xy</span><span class="p">,</span><span class="n">true_box_wh</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 4: Calculate loss for the class probabilities</span>
    <span class="n">loss_class</span>  <span class="o">=</span> <span class="n">calc_loss_class</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span><span class="n">LAMBDA_CLASS</span><span class="p">,</span>
                                   <span class="n">true_box_class</span><span class="p">,</span><span class="n">pred_box_class</span><span class="p">)</span>
    <span class="c1"># Step 5: For each (grid cell, anchor) pair, </span>
    <span class="c1">#         calculate the IoU between predicted and ground truth bounding box</span>
    <span class="n">true_box_conf_IOU</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_assigned</span><span class="p">(</span><span class="n">true_box_conf</span><span class="p">,</span>
                                                    <span class="n">true_box_xy</span><span class="p">,</span> <span class="n">true_box_wh</span><span class="p">,</span>
                                                    <span class="n">pred_box_xy</span><span class="p">,</span> <span class="n">pred_box_wh</span><span class="p">)</span>
    <span class="c1"># Step 6: For each predicted bounded box from (grid cell, anchor box), </span>
    <span class="c1">#         calculate the best IOU, regardless of the ground truth anchor box that each object gets assigned.</span>
    <span class="n">best_ious</span> <span class="o">=</span> <span class="n">calc_IOU_pred_true_best</span><span class="p">(</span><span class="n">pred_box_xy</span><span class="p">,</span><span class="n">pred_box_wh</span><span class="p">,</span><span class="n">true_boxes</span><span class="p">)</span>
    <span class="c1"># Step 7: For each grid cell, calculate the L_{i,j}^{noobj}</span>
    <span class="n">conf_mask</span> <span class="o">=</span> <span class="n">get_conf_mask</span><span class="p">(</span><span class="n">best_ious</span><span class="p">,</span> <span class="n">true_box_conf</span><span class="p">,</span> <span class="n">true_box_conf_IOU</span><span class="p">,</span><span class="n">LAMBDA_NO_OBJECT</span><span class="p">,</span> <span class="n">LAMBDA_OBJECT</span><span class="p">)</span>
    <span class="c1"># Step 8: Calculate loss for the confidence</span>
    <span class="n">loss_conf</span> <span class="o">=</span> <span class="n">calc_loss_conf</span><span class="p">(</span><span class="n">conf_mask</span><span class="p">,</span><span class="n">true_box_conf_IOU</span><span class="p">,</span> <span class="n">pred_box_conf</span><span class="p">)</span>

    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_xywh</span> <span class="o">+</span> <span class="n">loss_conf</span> <span class="o">+</span> <span class="n">loss_class</span>
    

    
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Experiment-custom_loss">Experiment <code>custom_loss</code><a class="anchor-link" href="#Experiment-custom_loss">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [24]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">true_boxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b_batch</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s2">"float32"</span><span class="p">)</span>
<span class="n">loss_tf</span>    <span class="o">=</span> <span class="n">custom_loss</span><span class="p">(</span><span class="n">y_batch_tf</span><span class="p">,</span> <span class="n">y_pred_tf</span><span class="p">)</span> 
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">loss_tf</span><span class="p">,</span>
                    <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">true_boxes</span><span class="p">:</span> <span class="n">b_batch</span><span class="p">})</span>
<span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[24]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>6.406112</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://github.com/FairyOnIce/ObjectDetectionYolo">FairyOnIce/ObjectDetectionYolo</a>
 contains this ipython notebook and all the functions that I defined in this notebook.</p>
</div>
</div>
</div>

<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Yumi</span>
  </span>
<time datetime="2018-12-09T20:00:00-08:00" pubdate>Sun 09 December 2018</time>  <span class="categories">
    <a class="category" href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>
    <a class="category" href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>
  </span>
</p><div class="sharing">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" data-via="" data-counturl="https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html" >Tweet</a>
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://yumis-blog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
     
    </section>
</div>
<aside class="sidebar">

<section>
    <h1>Local Search</h1></hr>
    <form class="navbar-search" action="https://FairyOnIce.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="" name="q" id="tipue_search_input"><input type="submit" value="Go!"></form></li>
</section>
    
<section>

    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="https://FairyOnIce.github.io/2D-DCT.html">Two-dimensional Discrete Cosine Transform as a Linear Transformation</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/1D-DCT-vs-2D-DCT.html">What would happen if image is analyzed with 1D-DCT vs 2D-DCT?</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Grad-CAM-with-keras-vis.html">Grad-CAM with keras-vis</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Saliency-Map-with-keras-vis.html">Saliency Map with keras-vis</a>
      </li>
      <li class="post">
          <a href="https://FairyOnIce.github.io/Visualization-of-deep-learning-classification-model-using-keras-vis.html">Visualization of deep learning classification model using keras-vis</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="https://FairyOnIce.github.io/category/blog.html">Blog</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="https://FairyOnIce.github.io/tag/bleu.html">BLEU</a>,    <a href="https://FairyOnIce.github.io/tag/deep-learning.html">deep learning</a>,    <a href="https://FairyOnIce.github.io/tag/computer-vision.html">Computer Vision</a>,    <a href="https://FairyOnIce.github.io/tag/nlp.html">NLP</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-yolov2-on-pascal-voc2012-series.html">Object Detection using YOLOv2 on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/api.html">API</a>,    <a href="https://FairyOnIce.github.io/tag/pascal-voc2012.html">PASCAL VOC2012</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection-using-rcnn-on-pascal-voc2012-series.html">Object Detection using RCNN on Pascal VOC2012 series</a>,    <a href="https://FairyOnIce.github.io/tag/gps-watch.html">GPS watch</a>,    <a href="https://FairyOnIce.github.io/tag/spectrogram.html">Spectrogram</a>,    <a href="https://FairyOnIce.github.io/tag/heroku.html">Heroku</a>,    <a href="https://FairyOnIce.github.io/tag/object-detection.html">Object Detection</a>,    <a href="https://FairyOnIce.github.io/tag/game.html">Game</a>,    <a href="https://FairyOnIce.github.io/tag/tensorflow.html">TensorFlow</a>,    <a href="https://FairyOnIce.github.io/tag/celeba.html">CelebA</a>,    <a href="https://FairyOnIce.github.io/tag/statistics.html">Statistics</a>,    <a href="https://FairyOnIce.github.io/tag/model.html">Model</a>,    <a href="https://FairyOnIce.github.io/tag/natural-language-processing.html">Natural Language Processing</a>,    <a href="https://FairyOnIce.github.io/tag/fourier-transform.html">Fourier Transform</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="https://www.linkedin.com/notifications/" target="_blank">LinkedIn</a></li>
            <li><a href="https://github.com/FairyOnIce" target="_blank">Github</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="https://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="https://python.org/" target="_blank">Python.org</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Yumi -
  <span class="credit">Powered by <a href="https://getpelican.com">Pelican</a></span>
</p></footer>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-112020731-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'https://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-112020731-1');
    ga('send', 'pageview');
</script>
	<script type="text/javascript">
	  var disqus_shortname = 'yumis-blog';
          var disqus_identifier = '/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_url = 'https://FairyOnIce.github.io/Part_4_Object_Detection_with_Yolo_using_VOC_2012_data_loss.html';
          var disqus_title = 'Part 4 Object Detection using YOLOv2 on Pascal VOC2012 - loss';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</body>
</html>